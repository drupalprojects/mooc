<?php
/**
 * Implements hook_init().
 */
function mooc_helper_init() {
  // add css related to mooc helper instance
  drupal_add_css(drupal_get_path('module', 'mooc_helper') . '/css/mooc_helper.css');
}

/**
 * Implements hook_theme_registry_alter().
 */
function mooc_helper_theme_registry_alter(&$theme_registry) {
  // point to the mooc's way of handling book pagination
  $theme_registry['book_navigation']['template'] = drupal_get_path('module', 'mooc_helper') . '/templates/book-navigation';
  $theme_registry['book_navigation']['theme path'] = drupal_get_path('module', 'mooc_helper');
  unset($theme_registry['book_navigation']['path']);
}
/**
 * Implements hook_menu().
 */
function mooc_helper_menu() {
  $items = array();
  // Callback to load correct instructional outline
  $items['inst-outline'] = array(
    'title' => 'Instructional outline',
    'page callback' => '_cis_connector_transaction',
    'page arguments' => array(0),
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
  );
  // fix for typo shortcut
  $items['typo-shortcut'] = array(
    'title' => 'Typo',
    'page callback' => 'drupal_goto',
    'page arguments' => array('typo-reports'),
    'type' => MENU_CALLBACK,
    'access arguments' => array('access typo list'),
  );
  return $items;
}

/**
 * Return a list of all book roots as an array
 */
function _mooc_helper_all_book_outlines() {
  $outlines = array();
  // load all book outline etids
  foreach (book_get_books() as $book_id => $book) {
    // load book node fully
    $node = node_load($book['nid']);
    // create an array
    $outlines[$node->uuid] = $node->book['link_title'];
  }
  return $outlines;
}

/**
 * Implements hook_set_cis_service_data().
 */
function mooc_helper_set_cis_service_data($delta) {
  switch ($delta) {
    case 'initial':
    case 'interval':
      // report the outlines available, updated at the interval and first time
      $data = array(
        'field_service_data' => drupal_json_encode(_mooc_helper_all_book_outlines()),
      );
    break;
  }
  return $data;
}

/**
 * Implementation of hook_feeds_after_import().
 */
function mooc_helper_feeds_after_import(FeedsSource $source) {
  //TODO: Convert to D7 code
  //TODO: dump changed connotations about uuid location in D6
  //TODO: make sure this only applies to the initial outline import routine
  // need to clear the UUIDs of all imported nodes from the
  // get a list of nodes that were just imported
  $ary = array();
  /*$result = db_query("SELECT nid FROM {feeds_node_item} WHERE id='elms_node_import'");
  while ($val = db_fetch_array($result)) {
    $ary[] = $val['nid'];
  }
  if (count($ary) != 0) {
    // clear all nodes that came across
    db_query("DELETE FROM {uuid_node} WHERE nid IN(". db_placeholders($ary) .")", $ary);
    // clean up revisions if they exist
    db_query("DELETE FROM {uuid_node_revisions} WHERE nid IN(". db_placeholders($ary) .")", $ary);
    // clean up original import table
    db_query("DELETE FROM {feeds_node_item} WHERE id='elms_node_import'");
    // seed all nodes by saving them all again
    foreach ($ary as $nid) {
      $node = node_load($nid);
      $node->uuid = uuid_uuid();
      $node->revision_uuid = uuid_uuid();
      node_save($node);
    }
  }*/
}